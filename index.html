<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å°è²»è¨ˆç®—æ©Ÿ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            card: '#1e293b',
                            accent: '#38bdf8',
                            success: '#34d399',
                            text: '#f1f5f9',
                            muted: '#94a3b8'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #38bdf8;
            cursor: pointer;
            margin-top: -10px; 
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        /* Remove inner spin button for number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Loading spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .fa-spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-brand-dark min-h-screen flex items-center justify-center p-4 font-sans text-brand-text selection:bg-brand-accent selection:text-brand-dark">

    <div class="w-full max-w-md space-y-6">
        
        <!-- Header -->
        <div class="text-center space-y-1">
            <h1 class="text-3xl font-bold tracking-tight text-white">
                <i class="fa-solid fa-calculator text-brand-accent mr-2"></i>æ™ºæ…§å°è²»è¨ˆç®—æ©Ÿ
            </h1>
            <p class="text-brand-muted text-sm">è¼¸å…¥ç¨…å‰æˆ–ç¨…å¾Œé‡‘é¡ï¼Œè‡ªå‹•è¨ˆç®—</p>
        </div>

        <!-- Main Card -->
        <div class="glass-panel rounded-3xl p-6 shadow-2xl relative overflow-hidden">
            <!-- Decorative gradient blob -->
            <div class="absolute top-0 right-0 -mr-16 -mt-16 w-32 h-32 rounded-full bg-brand-accent opacity-10 blur-2xl pointer-events-none"></div>

            <!-- Tax Rate Setting (Toggleable or Visible) -->
            <div class="mb-6 bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                <div class="flex items-center justify-between">
                    <label class="text-sm text-brand-muted flex items-center gap-2">
                        <i class="fa-solid fa-file-invoice-dollar"></i> ç¶œåˆéŠ·å”®ç¨…ç‡ (%)
                    </label>
                    <div class="flex items-center gap-2">
                        <button id="locateBtn" class="text-brand-accent hover:text-white hover:bg-brand-accent/20 p-2 rounded-lg transition-all text-xs flex items-center gap-1" title="æ ¹æ“šä½ç½®è‡ªå‹•è¨­å®šç¨…ç‡">
                            <i class="fa-solid fa-location-crosshairs"></i>
                            <span class="hidden sm:inline">è‡ªå‹•åµæ¸¬</span>
                        </button>
                        <input type="number" id="taxRate" value="9.38" step="0.01" class="bg-transparent text-right font-bold text-brand-accent focus:outline-none w-20 border-b border-dashed border-slate-600 focus:border-brand-accent transition-colors" inputmode="decimal">
                    </div>
                </div>
                <div id="locationMsg" class="text-[10px] text-right text-brand-success mt-1 hidden"></div>
            </div>

            <!-- Inputs Section -->
            <div class="space-y-5">
                
                <!-- Pre-Tax Input -->
                <div class="relative group">
                    <label for="preTaxInput" class="block text-xs font-semibold uppercase tracking-wider text-brand-muted mb-1 ml-1">ç¨…å‰é‡‘é¡ (Pre-tax)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-lg">$</span>
                        <input type="number" id="preTaxInput" placeholder="0.00" inputmode="decimal" class="w-full bg-slate-800 text-white text-2xl font-bold py-4 pl-10 pr-4 rounded-xl border-2 border-slate-700 focus:border-brand-accent focus:outline-none focus:ring-4 focus:ring-brand-accent/20 transition-all placeholder-slate-600">
                    </div>
                </div>

                <!-- Post-Tax Input -->
                <div class="relative group">
                    <label for="postTaxInput" class="block text-xs font-semibold uppercase tracking-wider text-brand-muted mb-1 ml-1">ç¨…å¾Œç¸½é¡ (Post-tax)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-lg">$</span>
                        <input type="number" id="postTaxInput" placeholder="0.00" inputmode="decimal" class="w-full bg-slate-800 text-brand-text text-2xl font-bold py-4 pl-10 pr-4 rounded-xl border-2 border-slate-700 focus:border-purple-500 focus:outline-none focus:ring-4 focus:ring-purple-500/20 transition-all placeholder-slate-600">
                    </div>
                    <p class="text-[10px] text-brand-muted mt-1 text-right italic">*åŸºæ–¼ç¨…ç‡è‡ªå‹•æ›ç®—</p>
                </div>

                <!-- Tip Slider -->
                <div class="pt-2 pb-4">
                    <div class="flex justify-between items-end mb-4">
                        <label class="text-sm font-semibold text-brand-text">å°è²»æ¯”ä¾‹ (Tip %)</label>
                        <span id="tipPercentDisplay" class="text-2xl font-bold text-brand-accent">15%</span>
                    </div>
                    <input type="range" id="tipSlider" min="15" max="25" value="15" step="1" class="w-full">
                    <div class="flex justify-between text-xs text-brand-muted mt-2 px-1">
                        <span>15%</span>
                        <span>20%</span>
                        <span>25%</span>
                    </div>
                </div>

            </div>
        </div>

        <!-- Result Card -->
        <div class="bg-brand-accent rounded-3xl p-6 shadow-lg shadow-brand-accent/20 text-brand-dark transform transition-all duration-300">
            <div class="grid grid-cols-2 gap-4 divide-x divide-black/10">
                
                <!-- Tip Amount -->
                <div class="text-center pr-2">
                    <p class="text-xs font-bold uppercase tracking-wider opacity-70 mb-1">å°è²»é‡‘é¡</p>
                    <p class="text-3xl font-extrabold flex items-center justify-center gap-0.5">
                        <span class="text-lg opacity-60">$</span>
                        <span id="tipAmountDisplay">0.00</span>
                    </p>
                </div>

                <!-- Total Pay -->
                <div class="text-center pl-2">
                    <p class="text-xs font-bold uppercase tracking-wider opacity-70 mb-1">ç¸½æ”¯ä»˜é‡‘é¡</p>
                    <p class="text-4xl font-extrabold flex items-center justify-center gap-0.5">
                        <span class="text-xl opacity-60">$</span>
                        <span id="totalPayDisplay">0.00</span>
                    </p>
                </div>
            </div>
            
            <!-- Breakdown -->
            <div class="mt-6 pt-4 border-t border-black/10 flex justify-between text-xs font-semibold opacity-70">
                <span>ç¨…é¡ (Tax): $<span id="taxAmountDisplay">0.00</span></span>
                <span>(å°è²»åŸºæ–¼ç¨…å‰é‡‘é¡è¨ˆç®—)</span>
            </div>
        </div>

    </div>

    <script>
        // DOM Elements
        const taxRateInput = document.getElementById('taxRate');
        const locateBtn = document.getElementById('locateBtn');
        const locationMsg = document.getElementById('locationMsg');
        const preTaxInput = document.getElementById('preTaxInput');
        const postTaxInput = document.getElementById('postTaxInput');
        const tipSlider = document.getElementById('tipSlider');
        const tipPercentDisplay = document.getElementById('tipPercentDisplay');
        const tipAmountDisplay = document.getElementById('tipAmountDisplay');
        const totalPayDisplay = document.getElementById('totalPayDisplay');
        const taxAmountDisplay = document.getElementById('taxAmountDisplay');

        // State variables
        let taxRate = 9.38;
        let tipPercent = 15;
        let preTaxAmount = 0;

        // Simplified Tax Rate Database (For demo purposes)
        // ğŸš¨ Note: Sales tax is complex. These CA rates are common combined rates 
        // but may vary based on specific city/district.
        const TAX_RATES_DB = {
            'TW': { rate: 5.00, name: 'å°ç£ (ç‡Ÿæ¥­ç¨…)' },
            'JP': { rate: 10.00, name: 'æ—¥æœ¬ (æ¶ˆè²»ç¨…)' },
            'KR': { rate: 10.00, name: 'éŸ“åœ‹ (VAT)' },
            'GB': { rate: 20.00, name: 'è‹±åœ‹ (VAT)' },
            'AU': { rate: 10.00, name: 'æ¾³æ´² (GST)' },
            'US': {
                'default': 6.00, // US general fallback
                'CA_DEFAULT': 7.25, // CA State Minimum Rate
                'CA_COUNTIES': {
                    // Common Combined Sales Tax Rates (State + County + District/City Avg)
                    'LOS ANGELES COUNTY': 9.50,
                    'SAN DIEGO COUNTY': 8.25,
                    'SAN FRANCISCO': 8.63, // SF is County/City combined
                    'SACRAMENTO COUNTY': 8.75,
                    'ORANGE COUNTY': 7.75,
                    'SANTA CLARA COUNTY': 9.38, // Common rate for San Jose/Santa Clara City
                    'ALAMEDA COUNTY': 9.75,
                    'RIVERSIDE COUNTY': 7.75,
                    'SAN MATEO COUNTY': 9.38,
                    'CONTRA COSTA COUNTY': 9.25
                    // Add more counties as needed...
                },
                // Fallbacks for simple state matches
                'NY': 8.88,  // NYC approx
                'TX': 8.25,
                'FL': 7.00,
                'WA': 10.25,
                'IL': 10.25,
            }
        };

        // Utility: Format currency
        const formatCurrency = (num) => {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        };

        // Utility: Parse float safely
        const parseInput = (val) => parseFloat(val) || 0;

        // Feature: Auto-detect Tax Rate
        locateBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ã€‚');
                return;
            }

            // UI Loading State
            const originalBtnContent = locateBtn.innerHTML;
            locateBtn.innerHTML = '<i class="fa-solid fa-spinner"></i> åµæ¸¬ä¸­...';
            locateBtn.disabled = true;
            
            // Reset message styles
            locationMsg.classList.add('hidden');
            locationMsg.classList.remove('text-yellow-500');
            locationMsg.classList.add('text-brand-success');

            navigator.geolocation.getCurrentPosition(async (position) => {
                try {
                    const { latitude, longitude } = position.coords;
                    
                    // Use OpenStreetMap Nominatim API
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`Location API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    const address = data.address || {};
                    const countryCode = (address.country_code || '').toUpperCase();
                    
                    let foundRate = null;
                    let locationName = '';

                    // Logic to determine rate
                    if (TAX_RATES_DB[countryCode]) {
                        if (countryCode === 'US') {
                            const state = address.state || '';
                            const county = address.county || '';
                            const city = address.city || '';
                            
                            // 1. Check for California
                            if (state.includes('California')) {
                                const countyKey = (county.toUpperCase() || '')
                                    .replace(' COUNTY', '') 
                                    + ' COUNTY'; // Standardize the key

                                if (TAX_RATES_DB.US.CA_COUNTIES[countyKey]) {
                                    // Found a specific county rate
                                    foundRate = TAX_RATES_DB.US.CA_COUNTIES[countyKey];
                                    
                                    if (city) {
                                        locationName = `${city}, ${county} (åŠ å·)`;
                                    } else {
                                        locationName = `${county} (åŠ å·)`;
                                    }

                                } else {
                                    // Fallback to CA State Minimum Rate if county not found
                                    foundRate = TAX_RATES_DB.US.CA_DEFAULT; 
                                    locationName = 'åŠ å· (CA å·åŸºæœ¬ç¨…ç‡)';
                                }

                            } else {
                                // 2. Check other simple US states
                                if (TAX_RATES_DB.US.NY && state.includes('New York')) { foundRate = TAX_RATES_DB.US.NY; locationName = 'ç´ç´„ (New York)'; }
                                else if (TAX_RATES_DB.US.TX && state.includes('Texas')) { foundRate = TAX_RATES_DB.US.TX; locationName = 'å¾·å· (Texas)'; }
                                else if (TAX_RATES_DB.US.FL && state.includes('Florida')) { foundRate = TAX_RATES_DB.US.FL; locationName = 'ä½›ç¾…é‡Œé” (Florida)'; }
                                else if (TAX_RATES_DB.US.WA && state.includes('Washington')) { foundRate = TAX_RATES_DB.US.WA; locationName = 'è¯ç››é “å· (Washington)'; }
                                else if (TAX_RATES_DB.US.IL && state.includes('Illinois')) { foundRate = TAX_RATES_DB.US.IL; locationName = 'ä¼Šåˆ©è«¾å· (Illinois)'; }
                                
                                if (foundRate === null) {
                                    foundRate = TAX_RATES_DB.US.default; 
                                    locationName = 'ç¾åœ‹ (é è¨­)';
                                }
                            }
                            
                        } else {
                            // Non-US Countries
                            foundRate = TAX_RATES_DB[countryCode].rate;
                            locationName = TAX_RATES_DB[countryCode].name;
                        }
                    }

                    if (foundRate !== null) {
                        taxRate = foundRate;
                        taxRateInput.value = foundRate.toFixed(2);
                        
                        // Show success message
                        locationMsg.textContent = `ğŸ“ å·²åˆ‡æ›è‡³ ${locationName}`;
                        locationMsg.classList.remove('hidden');
                        
                        updateCalculations();
                    } else {
                        locationMsg.textContent = `âš ï¸ æœªçŸ¥åœ°å€ (${countryCode})ï¼Œç¶­æŒåŸè¨­å®š`;
                        locationMsg.classList.remove('hidden');
                        locationMsg.classList.replace('text-brand-success', 'text-yellow-500');
                    }

                } catch (error) {
                    console.error("Locate error:", error.message || error);
                    alert('ç„¡æ³•å–å¾—è©³ç´°ä½ç½®è³‡è¨Šï¼Œè«‹æ‰‹å‹•è¼¸å…¥ç¨…ç‡ã€‚');
                } finally {
                    locateBtn.innerHTML = originalBtnContent;
                    locateBtn.disabled = false;
                }
            }, (error) => {
                // Log clear error message instead of object
                console.error("Geolocation Error:", error.message, "(Code: " + error.code + ")");
                let msg = 'ç„¡æ³•å–å¾—ä½ç½®ã€‚';
                if(error.code === 1) msg = 'è«‹å…è¨±ç€è¦½å™¨å­˜å–ä½ç½®ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚';
                alert(msg);
                locateBtn.innerHTML = originalBtnContent;
                locateBtn.disabled = false;
            });
        });

        // Core Calculation Function
        const updateCalculations = () => {
            try {
                // 1. Calculate Tax Amount
                const taxAmount = preTaxAmount * (taxRate / 100);
                
                // 2. Calculate Tip Amount (Tip is based on Pre-tax)
                const tipAmount = preTaxAmount * (tipPercent / 100);

                // 3. Calculate Post-tax (Pre + Tax)
                const postTaxAmount = preTaxAmount + taxAmount;

                // 4. Calculate Total Pay (Post-tax + Tip)
                const totalPay = postTaxAmount + tipAmount;

                // UI Updates
                if(tipPercentDisplay) tipPercentDisplay.textContent = `${tipPercent}%`;
                if(tipAmountDisplay) tipAmountDisplay.textContent = formatCurrency(tipAmount);
                if(totalPayDisplay) totalPayDisplay.textContent = formatCurrency(totalPay);
                if(taxAmountDisplay) taxAmountDisplay.textContent = formatCurrency(taxAmount);

                // Update Post-tax input only if it's not the currently focused element
                if (document.activeElement !== postTaxInput && postTaxInput) {
                    if (preTaxAmount === 0 && document.activeElement !== preTaxInput) {
                        postTaxInput.value = '';
                    } else {
                        postTaxInput.value = postTaxAmount > 0 ? postTaxAmount.toFixed(2) : '';
                    }
                }
            } catch (err) {
                console.error("Calculation Error:", err);
            }
        };

        // Event Listeners with Safety Checks
        if(taxRateInput) {
            taxRateInput.addEventListener('input', (e) => {
                let val = parseInput(e.target.value);
                if (val < 0) val = 0;
                taxRate = val;
                updateCalculations();
            });
        }

        if(preTaxInput) {
            preTaxInput.addEventListener('input', (e) => {
                preTaxAmount = parseInput(e.target.value);
                updateCalculations();
            });
        }

        if(postTaxInput) {
            postTaxInput.addEventListener('input', (e) => {
                const postVal = parseInput(e.target.value);
                const multiplier = 1 + (taxRate / 100);
                preTaxAmount = postVal / multiplier;
                if(preTaxInput) preTaxInput.value = preTaxAmount > 0 ? preTaxAmount.toFixed(2) : '';
                updateCalculations();
            });
        }

        if(tipSlider) {
            tipSlider.addEventListener('input', (e) => {
                tipPercent = parseInt(e.target.value);
                updateCalculations();
            });
        }

        // Initialize
        updateCalculations();

    </script>
</body>
</html>